/*
   Shellcast
   =========
*/var Shellcast=function(a){var b=this;a===undefined&&(a={});if(a.url===undefined)throw"Shellcast requires you pass a url";if(a.element===undefined)throw"Shellcast requires you pass an element";a.terminal_character_width===undefined&&(a.terminal_character_width=8),a.autoplay===undefined&&(a.autoplay=!0),b.params=a,b.element=a.element,$.ajax({url:a.url,dataType:"json",success:function(a){b.loadData(a)}})};Shellcast.ascii_table_map={8:"\u2190BSP",9:"\u21e5",10:"\u21a9",11:"\u21e5",13:"\u21a9",27:"ESC",32:"&nbsp;",127:"\u2190DEL"},Shellcast.control_code_map={"[B":"\u2193","OB":"\u2193","[C":"\u2192","OC":"\u2192","[A":"\u2191","OA":"\u2191","[D":"\u2190","OD":"\u2190"},Shellcast.prototype.loadData=function(a){var b=this;b.data=a,b.element.toggleClass("shellcast",!0);var c=new Terminal(a.term_cols,a.term_rows),d=$(c.open());b.terminalWrapper=$('<div class="terminal-wrapper"></div>').append(d),b.element.append(b.terminalWrapper),d.width(b.params.terminal_character_width*a.term_cols);var e=$('<div class="capture-mouse-events"></div>');b.terminalWrapper.append(e),e.hover($.proxy(b.hoverIn,b),$.proxy(b.hoverOut,b)),e.click($.proxy(b.click,b)),b.inputDisplayDiv=$('<div class="input-display"></div>'),b.element.append(b.inputDisplayDiv),b.inputDisplayDiv.width(b.params.terminal_character_width*a.term_cols),b.player=new Shellcast.Player(c),b.player.load(a),b.player.onStateChange=$.proxy(b.updateHover,b),b.player.onInputKey=$.proxy(b.addInputKey,b),b.params.autoplay&&b.player.play()},Shellcast.prototype.addInputKey=function(a){var b=this,c=a;if(Shellcast.control_code_map[a])c=Shellcast.control_code_map[a];else if(a.length===1){var d=a.charCodeAt(0);Shellcast.ascii_table_map[d]?c=Shellcast.ascii_table_map[d]:d<=31&&(c="Ctrl-"+String.fromCharCode(d+64))}var e=$('<kbd class="light">'+c+"</kbd>");b.inputDisplayDiv.prepend(e);var f=(new Date).valueOf();b.lastAddInputKey===undefined&&(b.lastAddInputKey=f);var g=f-b.lastAddInputKey;b.lastAddInputKey=f,e.css("margin-left",Math.floor(g/50)+"px"),window.setTimeout(function(){e.remove()},1e4)},Shellcast.prototype.hoverIn=function(){var a=this;if(a.hoverDiv!==undefined)return;a.hoverDiv=$('<div class="action-cover"></div>'),a.updateHover(a.player.state),a.terminalWrapper.prepend(a.hoverDiv),a.hoverDiv.css("top",a.terminalWrapper.height()/2-a.hoverDiv.height()/2+"px")},Shellcast.prototype.hoverOut=function(){this.hoverDiv.remove(),this.hoverDiv=undefined},Shellcast.prototype.click=function(){var a=this;a.player.playing?a.player.pause():a.player.paused?a.player.unpause():a.player.play()},Shellcast.prototype.updateHover=function(a){var b=this;a==="stopped"&&b.hoverIn();if(!b.hoverDiv)return;var c;a==="playing"?c="pause":a==="paused"?c="unpause":a==="stopped"?c="replay":c="play",b.hoverDiv.html(c)},Shellcast.Player=function(a){this.term=a,this.state=undefined,this.playing=!1,this.paused=!1,this.reachedLastFrame=!1,this.onStateChange=undefined,this.onInputKey=undefined},Shellcast.Player.prototype.load=function(a){this.data=a},Shellcast.Player.prototype.play=function(){var a=this;if(a.playing)return;a.stateChange("playing"),a.reachedLastFrame&&(a.reachedLastFrame=!1,a.term.reset()),a.currentFrame=-1,a.playNextFrame()},Shellcast.Player.prototype.pause=function(){var a=this;if(a.paused)return;a.stateChange("paused"),a.nextFrameTimeoutHandle&&(window.clearTimeout(a.nextFrameTimeoutHandle),a.nextFrameTimeoutHandler=undefined)},Shellcast.Player.prototype.unpause=function(){var a=this;if(!a.paused)return;a.stateChange("playing"),a.playNextFrame()},Shellcast.Player.prototype.reset=function(){var a=this;a.playing&&a.pause,a.reachedLastFrame=!0,a.play()},Shellcast.Player.prototype.stateChange=function(a){var b=this;b.state=a,a==="playing"?(b.playing=!0,b.paused=!1,b.term.startBlink()):a==="stopped"?(b.reachedLastFrame=!0,b.playing=!1,b.term.stopBlink()):a==="paused"&&(b.playing=!1,b.paused=!0,b.term.stopBlink()),b.onStateChange&&b.onStateChange(a)},Shellcast.Player.prototype.playNextFrame=function(){var a=this;if(a.currentFrame+1>a.data.frames.length-1){a.stateChange("stopped");return}a.currentFrame=a.currentFrame+1;var b=a.data.frames[a.currentFrame];if(b===undefined){console.error("Frame "+a.currentFrame+" doesn't exist");return}if(!$.isArray(b)||b.length!==3){console.error("Frame "+a.currentFrame+" is not an array with three items",b);return}if(b[0]==="in"&&a.onInputKey)a.onInputKey(b[2]);else{if(b[0]!=="out"){console.error("Frame "+a.currentFrame+" has unsupported type",b);return}a.term.write(b[2])}var c=0;a.currentFrame<a.data.frames.length-1&&(c=a.data.frames[a.currentFrame+1][1]),a.nextFrameTimeoutHandle=window.setTimeout(function(){a.playNextFrame()},c)};